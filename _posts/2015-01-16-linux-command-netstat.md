---
layout: post
title: Linux命令之netstat命令和一些 TCP 知识
category: tech
tags: linux linux-command
---

在Internet RFC标准中，Netstat的定义是： Netstat是在内核中访问网络及相关信息的程序，它能提供TCP连接，TCP和UDP监听，进程内存管理的相关报告。
Netstat是是一个监控TCP/IP网络的非常有用的工具，它可以显示路由表、实际的网络连接以及每一个网络接口设备的状态信息。Netstat用于显示与IP、TCP、UDP和ICMP协议相关的统计数据，一般用于检验本机各端口的网络连接情况。

## 格式
	
	该命令的一般格式为 ：
	netstat [-a][-e][-n][-o][-p Protocol][-r][-s][Interval]
	命令中各选项的含义如下：
	  
	-a 显示所有socket，包括正在监听的。
	-c 每隔1秒就重新显示一遍，直到用户中断它。
	-i 显示所有网络接口的信息，再加上-e，内容便和ifconfig一样。
	-n 禁用反向域名解析，加快查询速度
	-r 显示核心路由表，格式同“route -e”。
	-t 显示TCP协议的连接情况
	-u 显示UDP协议的连接情况。
	-v 显示正在进行的工作。
	-l 只列出监听中的连接.(LISTEN)
	-p 选项查看进程信息
	-g 会输出 IPv4 和 IPv6 的多播组信息。




## 常用选项
	netstat -s
		——本选项能够按照各个协议分别显示其统计数据。如果你的应用程序（如Web浏览器）运行速度比较慢，或者不能显示Web页之类的数据，那么你就可以用本选项来查看一下所显示的信息。你需要仔细查看统计数据的各行，找到出错的关键字，进而确定问题所在。
	netstat -e
		——本选项用于显示关于以太网的统计数据，它列出的项目包括传送数据报的总字节数、错误数、删除数，包括发送和接收量（如发送和接收的字节数、数据包数），或有广播的数量。可以用来统计一些基本的网络流量。
	netstat -r
		——本选项可以显示关于路由表的信息，类似于后面所讲使用route print命令时看到的信息。除了显示有效路由外，还显示当前有效的连接。
	netstat -a
		——本选项显示一个所有的有效连接信息列表，包括已建立的连接（ESTABLISHED），也包括监听连接请求（LISTENING）的那些连接。
	netstat -n
		——显示所有已建立的有效连接。
	netstat -nlpt
		——查看端口和连接的信息时，能查看到它们对应的进程名和进程号对系统管理员来说是非常有帮助的。举个栗子，Apache 的 httpd 服务开启80端口，如果你要查看 http 服务是否已经启动，或者 http 服务是由 apache 还是 nginx 启动的，这时候你可以看看进程名。
	netstat -ltpe
		——使用 -ep 选项可以同时查看进程名和用户名。
	netstat -ant
		——查看已建立的tcp端口情况。
		
## 一些其它TCP的知识		
		

### TCP连接

先上一下客户端与服务器进行TCP连接的过程。TCP连接的的过程有很多状态，不同的连接状态，都有想对应的状态码：

	LISTEN：侦听来自远方的TCP端口的连接请求
	SYN-SENT：再发送连接请求后等待匹配的连接请求
	SYN-RECEIVED：再收到和发送一个连接请求后等待对方对连接请求的确认
	ESTABLISHED：代表一个打开的连接
	FIN-WAIT-1：等待远程TCP连接中断请求，或先前的连接中断请求的确认
	FIN-WAIT-2：从远程TCP等待连接中断请求
	CLOSE-WAIT：等待从本地用户发来的连接中断请求
	CLOSING：等待远程TCP对连接中断的确认
	LAST-ACK：等待原来的发向远程TCP的连接中断请求的确认
	TIME-WAIT：等待足够的时间以确保远程TCP接收到连接中断请求的确认
	CLOSED：没有任何连接状态

相对应的就是下图：
![vim](http://7vigrt.com1.z0.glb.clouddn.com/three-way-shakehand.jpg)
		
### 连接状态

在原模式中没有状态，在用户数据报协议中也经常没有状态，于是状态列可以空出来。若有状态，可以对应TCP的三次握手四次挥手过程，通常取值为：
	
	LISTEN
		侦听来自远方的TCP端口的连接请求
	SYN-SENT
		再发送连接请求后等待匹配的连接请求
	SYN-RECEIVED
		再收到和发送一个连接请求后等待对方对连接请求的确认
	ESTABLISHED
		代表一个打开的连接 
	FIN-WAIT-1
		等待远程TCP连接中断请求，或先前的连接中断请求的确认
	FIN-WAIT-2
		从远程TCP等待连接中断请求
	CLOSE-WAIT
		等待从本地用户发来的连接中断请求
	CLOSING
		等待远程TCP对连接中断的确认
	LAST-ACK
		等待原来的发向远程TCP的连接中断请求的确认
	TIME-WAIT
		等待足够的时间以确保远程TCP接收到连接中断请求的确认
	CLOSED
		没有任何连接状态
		
		
### 基于三次握手的SYN洪水攻击(摘自[百度百科](http://baike.baidu.com/link?url=x9wJlz06go2eX66zKmA_qsVXPMF-XFaOhyVzpq6lrKwRQsPJW0cGO6r52A9OYxP55sC98NWc_N3TW1npXV4EJ_))

建设一个小型的模仿环境假设有3台接入互联网的机器。A为攻击者操纵的攻击机。B为中介跳板机器（受信任的服务器）。C为受害者使用的机器（多是服务器），这里把C机器锁定为目标机器。A机器向B机器发送SYN包，请求建立连接，这时已经响应请求的B机器会向A机器回应SYN/ACK表明同意建立连接，当A机器接受到B机器发送的SYN/ACK回应时，发送应答ACK建立A机器与B机器的网络连接。这样一个两台机器之间的TCP通话信道就建立成功了。
B终端受信任的服务器向C机器发起TCP连接，A机器对服务器C发起SYN信息，使C机器不能响应B机器。在同时A机器也向B机器发送虚假的C机器回应的SYN数据包，接收到SYN数据包的B机器（被C机器信任）开始发送应答连接建立的SYN/ACK数据包，这时C机器正在忙于响应以前发送的SYN数据而无暇回应B机器，A机器的攻击者预测出B机器包的序列号（TCP序列号预测难度有些大）假冒C机器向B机器发送应答ACK这时攻击者骗取B机器的信任，假冒C机器与B机器建立起TCP协议的对话连接。这个时候的C机器还是在响应攻击者A机器发送的SYN数据。

TCP协议栈的弱点

TCP连接的资源消耗，其中包括：数据包信息、条件状态、序列号等。通过故意不完成建立连接所需要的三次握手过程，造成连接一方的资源耗尽。
通过攻击者有意的不完成建立连接所需要的三次握手的全过程，从而造成了C机器的资源耗尽。序列号的可预测性，目标主机应答连接请求时返回的SYN/ACK的序列号时可预测的。
